# 📊 v4.9 - 分时图表增强与智能日期选择

**发布时间**: 2025年12月

**更新类型**: 🚀 **功能增强更新**

## 📈 分时图表渲染引擎重构

- ✅ **图表库切换**: 从 `timeserieslinechart` 切换到基础 `linechart` + `canvas`，获得更精确的控制能力
- ✅ **Braille 字符绘制**: 使用 `DrawBrailleLineWithStyle` 实现平滑的折线曲线
- ✅ **自定义X轴标签**: 显示整点/半点时间（如 09:30, 10:00, 10:30...）
- ✅ **颜色编码**: 上涨绿色、下跌红色、持平白色

## 🕐 智能日期选择

- ✅ **开盘前智能切换**: 9:30 之前自动显示上一个交易日的分时数据
- ✅ **盘中/收盘后**: 9:30 之后显示当天的分时数据
- ✅ **周末跳过**: 自动跳过周六、周日，找到最近的交易日
- ✅ **用户体验优化**: 避免开盘前查看图表时出现空白

```go
// 智能日期选择逻辑
func getSmartChartDate() string {
    now := time.Now()
    if now.Hour() < 9 || (now.Hour() == 9 && now.Minute() < 30) {
        return findPreviousTradingDayFromDate(now.Format("20060102"))
    }
    return now.Format("20060102")
}
```

## 📈 自适应Y轴边距算法

- ✅ **波动率感知**: 根据价格波动幅度动态调整Y轴边距
- ✅ **低波动（<1%）**: 使用50%边距，放大微小变化的可视性
- ✅ **中等波动（1-3%）**: 使用20%边距
- ✅ **高波动（>3%）**: 使用10%边距
- ✅ **最小边距保证**: 确保至少0.3%的价格边距

```go
// 自适应边距计算
func calculateAdaptiveMargin(prices []float64) (min, max, margin float64) {
    volatility := (maxPrice - minPrice) / minPrice * 100
    if volatility < 1.0 {
        marginRatio = 0.5  // 50% for low volatility
    } else if volatility < 3.0 {
        marginRatio = 0.2  // 20% for medium
    } else {
        marginRatio = 0.1  // 10% for high
    }
    // ...
}
```

## ⏰ 固定时间框架

- ✅ **完整交易时段**: 创建 9:30-15:00 的完整时间轴（331个数据点）
- ✅ **午休时段处理**: 包含11:30-13:00午休时段，保持时间映射正确
- ✅ **缺失数据填充**: 使用最后已知价格填充缺失的时间点
- ✅ **连续时间轴**: 确保图表X轴均匀分布

## 🎯 图表界面增强

- ✅ **交易时段提示**: 显示 "⏰ 交易时段: 9:30开盘 | 11:30午休 | 13:00午盘 | 15:00收盘"
- ✅ **时间标签优化**: X轴显示整点和半点时间，更直观
- ✅ **精度提升**: 价格显示保持3位小数精度

## 📋 核心改进

```
图表引擎: linechart + canvas 替代 timeserieslinechart
智能日期: 开盘前自动选择上一交易日
Y轴边距: 根据波动率自适应调整
时间框架: 完整 9:30-15:00 时间轴（331点）
界面增强: 交易时段提示和优化的X轴标签
```

## 📁 代码变更

**修改文件**：
- `main.go` - 图表相关函数重构（+186行，6,238 → 6,424行）

**新增函数**：
- `getSmartChartDate()` - 智能日期选择
- `findPreviousTradingDayFromDate()` - 查找上一交易日
- `calculateAdaptiveMargin()` - 自适应边距计算
- `createFixedTimeRange()` - 创建固定时间框架
- `TimePoint` 结构体 - 时间点数据结构

**修改函数**：
- `createIntradayChart()` - 重构为使用基础 linechart
- `viewIntradayChart()` - 添加交易时段提示
- `handleMonitoring()` - 使用智能日期选择
- `handleWatchlistViewing()` - 使用智能日期选择

**依赖变更**：
```go
// 旧
import "github.com/NimbleMarkets/ntcharts/linechart/timeserieslinechart"

// 新
import (
    "github.com/NimbleMarkets/ntcharts/canvas"
    "github.com/NimbleMarkets/ntcharts/linechart"
)
```

## 🔄 与v4.8对比优势

| 特性 | v4.8多标签版本 | v4.9图表增强版本 |
|-----|----------------|----------------|
| 图表引擎 | timeserieslinechart | linechart + canvas |
| 日期选择 | 固定当天 | 智能选择（开盘前显示上一交易日） |
| Y轴边距 | 固定5%边距 | 根据波动率自适应（10%-50%） |
| 时间框架 | 仅显示有数据的时间点 | 完整9:30-15:00时间轴 |
| 午休处理 | 可能显示异常 | 正确处理午休时段 |
| 交易时段提示 | ❌ 无 | ✅ 显示关键时间点 |
| X轴标签 | 自动格式化 | 整点/半点时间 |

## 💡 使用说明

### 查看分时图表

1. 在持股列表或自选列表中，选中目标股票
2. 按 `V` 键进入分时图表视图
3. 系统自动选择合适的日期显示图表

### 智能日期行为

| 当前时间 | 显示日期 | 说明 |
|---------|---------|------|
| 周一 08:00 | 上周五 | 开盘前，跳过周末 |
| 周一 09:30 | 周一 | 盘中 |
| 周一 16:00 | 周一 | 收盘后 |
| 周六 10:00 | 周五 | 周末，显示周五 |

## 🐛 修复问题

- ✅ 修复开盘前查看图表时显示空白的问题
- ✅ 修复午休时段时间轴跳跃的问题
- ✅ 修复低波动股票图表显示为直线的问题
- ✅ 优化图表渲染精度

## 📈 升级建议

1. **无需配置变更**: 本版本无新增配置项，开箱即用
2. **自动生效**: 升级后图表功能自动使用新引擎
3. **向后兼容**: 分时数据格式不变，历史数据正常使用
