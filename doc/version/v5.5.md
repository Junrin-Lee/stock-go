# 🏷️ v5.5 - 自选股票市场标签体系

**发布时间**: 2025年12月22日
**更新类型**: ✨ **功能增强与架构优化**

## 🎯 版本概述

v5.5 引入了**自选股票的市场标签体系**，为每只股票自动关联其所属市场（A股/美股/港股），并在UI中显示市场标签。这是继v5.4港股换手率修复之后的又一重要功能更新，增强了自选股票的分组管理能力。

**核心特性**:
- 🏷️ **自动市场识别** - 根据股票代码自动判断市场类型
- 📊 **市场标签显示** - 在自选列表中显示市场标签（A股/美股/港股）
- 🔄 **向下兼容** - 自动迁移旧版本数据，处理市场标签清理
- 🌐 **多语言支持** - 市场标签支持中文和英文显示
- 📈 **灵活分组** - 支持按市场标签和用户标签双维度分组

**完全向后兼容** v5.4 及更早版本，平滑升级无任何风险。

---

## ✨ 主要特性

### 1. 自动市场识别 🎯

系统能够根据股票代码自动识别市场类型，无需用户手动配置：

| 股票代码 | 市场类型 | 识别规则 |
|--------|---------|---------|
| `SH600000`, `600000` | A股 | 上交所代码（6位，以6开头） |
| `SZ000001`, `000001` | A股 | 深交所代码（6位，以0开头） |
| `AAPL`, `TSLA` | 美股 | 英文代码 |
| `HK00700`, `0700.HK` | 港股 | HK前缀或.HK后缀 |

### 2. 市场标签显示 🏷️

自选列表中新增市场标签显示，与用户自定义标签并存：

```
自选列表示例:
┌──────────┬──────────┬──────────┬────────┬─────────┬─────────┬────────┬────────┐
│   市场   │   标签   │   代码   │   名称 │  现价   │ 涨幅%   │ 换手率 │ 成交量 │
├──────────┼──────────┼──────────┼────────┼─────────┼─────────┼────────┼────────┤
│ A股      │ 白酒     │ SH600519 │ 贵州茅台 │1668.00 │  +1.25% │ 0.35%  │  3.2万 │
│ A股      │ 科技     │ SZ000725 │ 京东方A │   4.52 │  -0.88% │ 1.82%  │ 15.6亿 │
│ 美股     │ 科技     │ AAPL     │ 苹果    │ 189.95 │  +0.85% │   -    │ 52.3M  │
│ 港股     │          │ HK00700  │ 腾讯控股 │  50.20 │  +1.10% │ 0.19%  │ 17.7M  │
└──────────┴──────────┴──────────┴────────┴─────────┴─────────┴────────┴────────┘
```

### 3. 数据迁移与兼容 🔄

自动处理旧版本数据中的市场标签：

- **清理过时标签** - 移除旧版本中保存的市场标签（如 "A股", "A-Share" 等）
- **智能识别** - 保留用户自定义标签，转移市场信息到Market字段
- **零数据丢失** - 完整迁移所有用户自定义标签

### 4. 按市场分组查看 📊

支持按市场标签筛选自选股票：

```
功能说明:
- 按 T 进入标签管理
- 可按 "A股", "美股", "港股" 等市场标签过滤
- 支持市场标签与用户标签的联合筛选
```

---

## 🔧 技术实现

### 数据结构变更

#### `types.go` - 添加Market字段

```go
// WatchlistStock 自选股票数据结构
type WatchlistStock struct {
    Code   string     `json:"code"`
    Name   string     `json:"name"`
    Tags   []string   `json:"tags"`             // 仅存储用户自定义标签
    Market MarketType `json:"market,omitempty"` // 市场类型标识
}

// MarketType 市场类型定义
type MarketType string

const (
    MarketChina    MarketType = "china"    // A股
    MarketUS       MarketType = "us"       // 美股
    MarketHongKong MarketType = "hongkong" // 港股
)
```

### 新增函数（watchlist.go）

#### 市场标签函数集合

```go
// getMarketTagName 根据市场类型和语言获取标签名称
// 返回值: "A股"(中文) 或 "A-Share"(英文)
func (m *Model) getMarketTagName(market MarketType) string

// isMarketTag 判断标签是否为市场标签
// 用于数据迁移时识别和清理市场标签
func isMarketTag(tag string) bool
```

#### 标签管理增强

```go
// getAvailableTags 获取所有可用标签（包括市场标签）
// 返回值: []string，包括市场标签和用户自定义标签

// getFilteredWatchlist 根据标签过滤（支持市场标签）
// 支持按市场标签或用户标签过滤
```

#### 标签显示增强

```go
// getTagsDisplay 获取标签显示字符串
// 改变: 现在需要传入 Model 参数，以支持动态生成市场标签
// 签名: func (stock *WatchlistStock) getTagsDisplay(m *Model) string
// 返回值: "A股,白酒" 或 "美股,科技,医药" 等
```

### 数据迁移逻辑（persistence.go）

#### WatchlistStockLegacy 增强

```go
type WatchlistStockLegacy struct {
    Code   string     `json:"code"`
    Name   string     `json:"name"`
    Tag    string     `json:"tag,omitempty"`    // 旧版单个标签
    Tags   []string   `json:"tags,omitempty"`   // 多标签
    Market MarketType `json:"market,omitempty"` // 兼容已有market字段
}
```

#### 迁移策略

```
加载旧版本数据时:
  1. 自动识别市场类型: getMarketType(code)
  2. 清理市场标签: 移除 "A股", "美股", "港股" 等
  3. 保留用户标签: 其他标签保留到Tags数组
  4. 结果: 新结构中Market和Tags分离
```

### 多语言支持

#### i18n/zh.json - 新增4个翻译键

```json
{
  "marketTag.china": "A股",
  "marketTag.us": "美股",
  "marketTag.hongkong": "港股",
  "marketInfo": "市场"
}
```

#### i18n/en.json - 新增4个翻译键

```json
{
  "marketTag.china": "A-Share",
  "marketTag.us": "US Stock",
  "marketTag.hongkong": "HK Stock",
  "marketInfo": "Market"
}
```

### 调用链更新

由于 `getTagsDisplay()` 现在需要 Model 参数，以下调用点已更新：

| 文件 | 函数 | 变更 |
|------|------|------|
| `columns.go` | `GenerateWatchlistRow()` | 传递 `m` 参数 |
| `main.go` | `viewWatchlistTagSelect()` | 传递 `m` 参数 |
| `main.go` | `viewWatchlistTagManage()` | 传递 `m` 参数 |
| `watchlist.go` | `viewWatchlistTagging()` | 显示市场信息 |

---

## 📊 文件变更统计

| 文件 | 变更类型 | 行数 | 说明 |
|------|---------|------|------|
| `watchlist.go` | 新增+修改 | +65 | 市场标签函数集合、标签显示逻辑 |
| `persistence.go` | 修改 | +40 | 数据迁移、市场字段兼容、标签清理 |
| `types.go` | 修改 | +5 | WatchlistStock新增Market字段 |
| `main.go` | 修改 | +15 | 4处getTagsDisplay()调用更新、市场信息显示 |
| `columns.go` | 修改 | +1 | getTagsDisplay()参数更新 |
| `i18n/zh.json` | 新增 | +4 keys | 市场标签翻译 |
| `i18n/en.json` | 新增 | +4 keys | 市场标签翻译 |
| **总计** | | **~130 lines** | **7个文件** |

---

## 🔄 数据迁移流程

### 迁移逻辑详解

当用户升级到v5.5时，系统会自动处理数据：

```
旧数据示例 (v5.4):
{
  "code": "HK00700",
  "name": "腾讯控股",
  "tags": ["港股", "科技", "通讯"]  // 混合了市场标签和用户标签
}

   ↓ 迁移处理

新数据 (v5.5):
{
  "code": "HK00700",
  "name": "腾讯控股",
  "market": "hongkong",  // 市场类型
  "tags": ["科技", "通讯"]  // 仅用户标签
}
```

### 迁移规则

```
1. 识别市场类型
   - 检查code的格式
   - 调用getMarketType(code)获取市场类型
   - 设置到Market字段

2. 清理标签
   - 遍历Tags数组
   - 检查isMarketTag()
   - 移除所有市场标签

3. 保留用户标签
   - 保留非市场标签
   - 保留非"-"标签（空标签）
   - 结果数组可能为空

4. 特殊处理
   - 旧版单Tag字段转换到Tags数组
   - 空标签转为空数组（而非[""]）
```

---

## ✅ 测试验证

### 场景测试

#### 场景1: A股添加

```
操作: 添加 SH600000 (浦发银行) 到自选
预期: 
- Market = "china"
- 市场标签显示为 "A股" / "A-Share"
- Tags = []（初始为空）
```

#### 场景2: 美股添加

```
操作: 添加 AAPL (苹果) 到自选
预期:
- Market = "us"
- 市场标签显示为 "美股" / "US Stock"
- Tags = []（初始为空）
```

#### 场景3: 港股添加

```
操作: 添加 HK00700 (腾讯) 到自选
预期:
- Market = "hongkong"
- 市场标签显示为 "港股" / "HK Stock"
- Tags = []（初始为空）
```

#### 场景4: 旧版数据迁移

```
操作: 升级到v5.5，系统自动迁移旧版本watchlist.json
旧数据:
{
  "code": "SH600519",
  "tags": ["A股", "白酒", "消费"]
}

预期结果:
{
  "code": "SH600519",
  "market": "china",
  "tags": ["白酒", "消费"]
}
```

#### 场景5: 标签过滤

```
操作1: 按市场标签"A股"过滤
预期: 显示所有Market="china"的股票

操作2: 按用户标签"白酒"过滤
预期: 显示所有Tags包含"白酒"的股票

操作3: 显示所有标签
预期: 市场标签 + 用户标签合并显示
```

---

## 🚀 升级指南

### 快速升级

#### 步骤1: 获取最新代码

```bash
cd /path/to/stock-monitor
git pull origin master
go build -o cmd/stock-monitor
```

#### 步骤2: 首次运行（自动迁移）

```bash
./cmd/stock-monitor
```

系统会自动处理数据迁移，无需手动操作。

#### 步骤3: 验证升级

**检查项1**: 自选列表显示市场标签
- 打开自选列表
- 查看表格是否新增"市场"列或列中显示市场标签
- 应显示如 "A股", "美股", "港股" 等

**检查项2**: 旧版标签清理
- 如果之前自选中有带市场标签的数据
- 升级后市场标签应自动迁移到Market字段
- 仅保留用户自定义标签

**检查项3**: 添加新股票
- 新增A股、美股、港股时
- 应自动显示对应的市场标签

### 向后兼容性

✅ **完全向后兼容** v5.4 及更早版本

- **配置文件** - 无新增配置，无需修改
- **现有功能** - 所有v5.4功能继续正常工作
- **数据文件** - 自动迁移，无需手动处理
- **API调用** - 新增参数(Model)透明处理

**迁移风险**: ✅ **零风险** - 可安全升级

---

## 🎨 UI变更

### 自选列表视图变化

#### 标签管理界面增强

```
选中股票时显示:
股票: HK00700 (腾讯控股)
市场: 港股
当前标签: 科技,通讯

输入新标签(多个逗号分隔): _
```

对比v5.4:
```
股票: HK00700 (腾讯控股)
当前标签: 港股,科技,通讯  ← 市场标签混在用户标签中

输入新标签(多个逗号分隔): _
```

### 标签列表视图增强

在获取所有可用标签时，现在会包含市场标签：

```
可用标签列表:
 ☑ A股          ← 市场标签（自动生成）
 ☑ 美股         ← 市场标签（自动生成）
 ☑ 港股         ← 市场标签（自动生成）
 ☑ 白酒         ← 用户标签
 ☑ 科技         ← 用户标签
 ☑ 消费         ← 用户标签
```

---

## 📝 代码质量

### 代码统计
- **新增代码**: ~65行
- **修改代码**: ~65行
- **总计**: ~130行
- **涉及文件**: 7个

### 兼容性检查
- ✅ 向后兼容v5.4
- ✅ 自动数据迁移
- ✅ 零配置升级
- ✅ 所有测试通过

### 代码风格
- ✅ 遵循Go最佳实践
- ✅ 遵循项目命名规范
- ✅ 完整的中英文注释
- ✅ 无代码重复

---

## 🔗 相关功能

### 与其他版本的关系

**v5.4** → **v5.5** 的演进:
- v5.4: 解决了港股换手率数据缺失问题
- v5.5: 为所有市场的股票提供统一的市场标签体系

两者形成完整的港股支持链：
1. v5.4: 补充港股换手率数据
2. v5.5: 为港股提供市场标签识别

### 后续版本规划

#### v5.6 计划

- [ ] **市场看板** - 按市场的综合数据视图
- [ ] **市场切换** - 快速切换查看不同市场
- [ ] **市场对标** - 对比不同市场的表现

---

## 📋 更新日志

### v5.5.0 (2025-12-22)

#### ✨ 新增功能

- ✅ **自动市场识别** - 根据股票代码自动判断市场类型（A股/美股/港股）
  - 支持多种代码格式识别（SH/SZ前缀、HK前缀、纯数字等）
  - Market字段自动填充，无需用户手动配置

- ✅ **市场标签显示** - 在UI中显示股票所属市场
  - 自选列表新增市场信息显示
  - 标签管理界面显示市场和用户标签分离
  - 支持按市场标签过滤和分组

- ✅ **数据迁移工具** - 自动处理旧版本数据
  - 智能识别旧版本中混入的市场标签
  - 自动清理过时市场标签
  - 完整保留用户自定义标签

#### 🌐 多语言支持

- ✅ **中文支持** - 市场标签显示为 "A股", "美股", "港股"
- ✅ **英文支持** - 市场标签显示为 "A-Share", "US Stock", "HK Stock"

#### 🔧 技术改进

- ✅ **数据结构优化** - WatchlistStock新增Market字段
  - 分离市场类型和用户标签
  - 清晰的数据存储和显示逻辑

- ✅ **函数接口升级** - getTagsDisplay()现在支持参数传递
  - 动态生成市场标签
  - 支持语言切换

#### 📊 测试覆盖

- ✅ **集成测试** - 验证市场识别逻辑
- ✅ **迁移测试** - 验证数据自动迁移
- ✅ **UI测试** - 验证市场标签显示

---

## 导航

- **上一版本**: [查看 v5.4 版本文档](v5.4.md)
- **下一版本**: v5.6（规划中）
- **版本索引**: [返回版本总览](README.md)
- **项目文档**: [查看项目主文档](../../CLAUDE.md)
