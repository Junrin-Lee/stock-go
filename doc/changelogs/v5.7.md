# 🏷️ v5.7 - 自选标签分组系统

**发布时间**: 2025年12月26日
**更新类型**: ✨ **用户体验优化**

## 🎯 版本概述

v5.7 引入了**自选列表的分组标签选择界面**，清晰区分市场标签（A股/美股/港股）和用户自定义标签，并提供光标位置记忆功能，显著改善了标签筛选体验。

**核心特性**:
- 📂 **标签分组显示** - 市场分组与用户标签清晰分类
- 📌 **位置记忆** - 记住上次选择，快速回到上次位置
- 🎨 **视觉优化** - 分组间清晰分隔，提升可读性
- 🔄 **边界停留** - 列表首尾停留，避免循环滚动
- 🌐 **双语完善** - 完整的中英文支持

**完全向后兼容** v5.6 及更早版本。

---

## ✨ 主要特性

### 1. 分组标签选择界面 📂

全新的标签选择UI，清晰区分不同类型的标签：

```
=== 选择标签分组 ===

当前过滤: A股

--- 市场分组 ---
> A股
  美股
  港股

--- 自定义标签 ---
  白酒
  科技
  新能源
  医药

操作: ↑/↓选择, Enter确认, C清除过滤, ESC/Q返回
```

**特点**:
- **固定顺序市场标签**: A股 → 美股 → 港股（按市场重要性排列）
- **字母排序用户标签**: 自动按字母排序，便于查找
- **分组标题**: 清晰标识不同标签来源

### 2. 光标位置记忆 📌

**智能位置恢复**:
- 记住上次选择的标签
- 再次进入分组界面时自动定位到该标签
- 提升多次筛选操作的效率

**示例场景**:
```
首次筛选: 选择"科技" → 查看科技股
按G返回: 光标自动定位到"科技" ✅
快速切换: 无需重新滚动查找
```

### 3. 边界停留行为 🛑

**改进的滚动逻辑**:
- 到达列表顶部时停留（不循环到底部）
- 到达列表底部时停留（不循环到顶部）
- 提供更直观的导航体验

---

## 🔧 技术实现

### 数据结构变更

#### `types.go` - 新增TagGroup类型

```go
// TagGroup 标签分组结构 (v5.7)
type TagGroup struct {
    Name string   // 分组名称 (如 "市场分组", "自定义标签")
    Tags []string // 该分组下的标签列表
}
```

#### `types.go` - Model字段扩展

```go
type Model struct {
    // ... 现有字段

    // v5.7 新增字段
    tagGroups            []TagGroup // 标签分组（市场分组 + 用户标签）
    lastSelectedGroupTag string     // 上次选中的标签（位置记忆）
}
```

### 核心函数实现 (`watchlist.go`)

#### `getMarketTags() []string`
```go
// 返回自选列表中存在的市场标签（固定顺序）
// 顺序: A股 → 美股 → 港股
// 只返回实际存在的市场类型
```

**实现逻辑**:
1. 遍历自选列表检查存在哪些市场
2. 按固定顺序返回：中国 → 美国 → 香港
3. 使用 `m.getMarketTagName()` 获取本地化名称

#### `getUserTags() []string`
```go
// 返回用户自定义标签（字母排序）
// 自动去重，排除空标签和"-"
```

**实现逻辑**:
1. 收集所有唯一的用户标签
2. 排除空标签和占位符
3. 使用 `sort.Strings()` 字母排序

#### `getTagGroups() []TagGroup`
```go
// 构建完整的标签分组结构
// 包含市场分组 + 用户标签分组
```

**返回结构**:
```go
[]TagGroup{
    {Name: "市场分组", Tags: ["A股", "美股", "港股"]},
    {Name: "自定义标签", Tags: ["白酒", "科技", "新能源"]}
}
```

#### `getTagAtCursor() string`
```go
// 根据当前光标位置获取标签名称
// 支持跨分组索引计算
```

**关键功能**:
- 计算光标在所有分组中的全局位置
- 返回对应的标签名称
- 光标越界时返回空字符串

#### `findTagPositionInGroups(tagName string) int`
```go
// 查找标签在分组中的全局位置
// 用于光标位置恢复
```

**用途**:
- 支持位置记忆功能
- 返回标签的全局索引
- 未找到时返回 -1

#### `getTotalTagCount() int`
```go
// 获取所有分组的标签总数
```

### UI渲染增强 (`watchlist.go`)

#### `viewWatchlistGroupSelect()` 重构

**改进前**:
```
- 单一列表显示所有标签
- 无分组区分
- 无位置记忆
- 循环滚动
```

**改进后**:
```
- 分组显示（市场/用户）
- 分组标题 + 分隔符
- 自动恢复上次位置
- 边界停留行为
- 双语支持完善
```

**渲染逻辑**:
1. 显示标题和当前过滤状态
2. 遍历每个分组渲染分组标题
3. 渲染分组内的标签（带光标指示）
4. 显示帮助文本

### 交互逻辑优化 (`main.go`)

#### `handleWatchlistGroupSelect()` 增强

**按键处理**:
```go
case "enter":
    selectedTag := m.getTagAtCursor()
    if selectedTag != "" {
        m.selectedTag = selectedTag
        m.lastSelectedGroupTag = selectedTag  // 记忆位置 ✅
    }
    m.invalidateWatchlistCache()
    m.state = WatchlistViewing

case "up", "k", "w":
    // 边界停留逻辑
    if m.cursor > 0 {
        m.cursor--
    }
    return m, nil

case "down", "j", "s":
    // 边界停留逻辑
    totalTags := m.getTotalTagCount()
    if m.cursor < totalTags-1 {
        m.cursor++
    }
    return m, nil
```

**进入分组界面时**:
```go
case "g":
    m.tagGroups = m.getTagGroups()
    totalTags := m.getTotalTagCount()

    if totalTags == 0 {
        m.message = m.getText("watchlist.noTags")
        return m, nil
    }

    // 尝试恢复到上次选择的标签位置
    m.cursor = 0
    if m.lastSelectedGroupTag != "" {
        position := m.findTagPositionInGroups(m.lastSelectedGroupTag)
        if position >= 0 {
            m.cursor = position
        }
    }

    m.state = WatchlistGroupSelect
```

### 国际化支持 (`i18n/`)

**新增翻译键** (`zh.json` / `en.json`):
```json
{
  "watchlist.selectGroup": "=== 选择标签分组 ===" / "=== Select Tag Group ===",
  "watchlist.currentFilter": "当前过滤" / "Current filter",
  "watchlist.noTags": "暂无可用标签" / "No tags available",
  "group.marketTags": "市场分组" / "Market Groups",
  "group.userTags": "自定义标签" / "User Tags",
  "group.helpText": "操作: ↑/↓选择, Enter确认, C清除过滤, ESC/Q返回" / "Actions: ↑/↓ select, Enter confirm, C clear filter, ESC/Q back"
}
```

---

## 🎨 用户体验改进

### 改进前 vs 改进后

| 方面 | v5.6及之前 | v5.7 |
|------|-----------|------|
| **标签分类** | 混合显示 | 清晰分组 ✅ |
| **市场标签顺序** | 无固定顺序 | 固定排序（中→美→港）✅ |
| **用户标签排序** | 随机 | 字母排序 ✅ |
| **位置记忆** | 无 | 自动记忆 ✅ |
| **视觉分隔** | 无 | 分组标题+分隔符 ✅ |
| **边界行为** | 循环滚动 | 边界停留 ✅ |

---

## 📊 性能影响

| 指标 | 影响 | 说明 |
|------|------|------|
| **内存使用** | +50 bytes | 仅增加一个字符串字段 |
| **渲染性能** | 无影响 | 分组渲染不增加时间复杂度 |
| **标签查找** | 略微提升 | 分组后视觉查找更快 |

---

## 📝 使用说明

### 如何使用

1. 在自选列表中按 `G` 键
2. 查看分组后的标签列表:
   - 上方: 市场分组（A股、美股、港股）
   - 下方: 用户标签（按字母排序）
3. 用 `↑` `↓` 选择标签
4. 按 `Enter` 应用筛选
5. 下次按 `G` 时，光标自动定位到上次选择

### 快捷键

| 按键 | 功能 |
|------|------|
| `↑` `↓` / `W` `S` / `K` `J` | 选择标签 |
| `Enter` / `Space` | 应用筛选 |
| `C` | 清除筛选 |
| `ESC` / `Q` | 返回自选列表 |

---

## 🔗 相关资源

- **Previous Version**: v5.6 (搜索视图增强)
- **Files Changed**:
  - `main.go`: 标签选择逻辑优化（handleWatchlistViewing, handleWatchlistGroupSelect）
  - `types.go`: 新增TagGroup结构，Model字段扩展
  - `watchlist.go`: 5个新函数（getMarketTags, getUserTags, getTagGroups, getTagAtCursor, findTagPositionInGroups, getTotalTagCount），1个重构函数（viewWatchlistGroupSelect）
  - `i18n/zh.json`, `i18n/en.json`: 6个新翻译键

---

## 🐛 已知限制

1. **标签数量**: 当标签超过50个时，建议优化分组逻辑（增加分页或搜索功能）
2. **动态更新**: 分组在进入时生成，不支持实时更新（退出后重新进入会更新）

---

## 🚀 下一步计划

- v5.8: 考虑支持标签重命名批量操作
- 增加标签统计功能（显示每个标签下的股票数量）
- 支持标签拖拽排序或优先级设置
- 分组内搜索功能（标签过多时）
