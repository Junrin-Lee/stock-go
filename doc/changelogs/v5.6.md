# 🔍 v5.6 - 搜索视图增强与实时图表

**发布时间**: 2025年12月24日
**更新类型**: ✨ **功能增强**

## 🎯 版本概述

v5.6 引入了**搜索结果页面的实时分时图表功能**，用户在搜索股票时可以立即查看该股票的分时走势，无需将其添加到自选或持仓列表。

**核心特性**:
- 🔍 **搜索即显示** - 搜索股票时自动展示分时图表
- ⚡ **实时更新** - 5秒自动刷新，保持数据最新
- 💡 **临时采集** - 搜索模式不持久化数据，减少磁盘占用
- 🎯 **快捷操作** - 支持ESC/Q快速退出搜索视图

**完全向后兼容** v5.5 及更早版本。

---

## ✨ 主要特性

### 1. 搜索结果实时图表 📈

在股票搜索结果页面新增分时图表显示：

```
搜索结果示例:
┌──────────────────────────────────────────────────────┐
│ 搜索结果: SH600000 (浦发银行)                         │
├──────────────────────────────────────────────────────┤
│                                                       │
│   8.60 ┤         ⠠⠊⠑⠢⡀                              │
│        │     ⠔⠁      ⠑⢄⠠⠔⠊⠢⡀                         │
│   8.55 ┤  ⡠⠊            ⠑⢄   ⠑⠢⡀                    │
│   8.50 ┼⠔⠁                  ⠑⠤⣀⠔⠊⠑⠢⣀                │
│        └─────────────────────────────────────────────│
│         09:30     11:00     13:00     15:00          │
│                                                       │
│ 实时更新中... (每5秒刷新)                             │
│                                                       │
│ [Enter] 添加到自选  [W] 添加到持股  [ESC/Q] 返回      │
└──────────────────────────────────────────────────────┘
```

### 2. 智能数据采集 🎯

**临时采集模式**:
- 仅在搜索视图激活时采集数据
- 退出搜索时自动停止worker
- 不保存到磁盘（data/intraday/目录）

**性能优化**:
- 复用现有intraday采集基础设施
- 最小化内存占用
- 自动清理临时数据

### 3. 交互增强 🚀

**快捷键支持**:
- `ESC` / `Q`: 退出搜索视图（新增Q键支持）
- `Enter`: 添加到自选列表（原有功能保留）
- `W`: 添加到持股列表（原有功能保留）

---

## 🔧 技术实现

### 代码变更

#### `main.go` 修改

**Search Mode Worker管理**:
```go
// handleSearchResult增强 - 支持Q键退出
case "esc", "q":
    m.state = MainMenu
    m.message = ""
    return m, nil

// handleSearchResultWithActions增强
case "esc", "q":  // 新增Q键退出支持
    // 停止搜索 worker 并清理数据
    if m.isSearchMode {
        m.stopSearchIntradayWorker()
    }
    m.state = MainMenu
```

**变更内容**:
- 新增搜索模式worker管理逻辑
- 扩展ESC退出逻辑，新增Q键支持
- 实现自动清理临时数据机制

#### `intraday_chart.go` 扩展 (+366 lines)

**新增函数**:
- 为搜索视图生成分时图的相关函数
- 支持临时数据源（非持久化）
- 与主视图图表渲染逻辑复用

**特性**:
- Braille字符平滑曲线渲染
- 智能Y轴自适应
- 固定时间框架（9:30-15:00）

#### `types.go` 字段扩展 (+11 lines)

**Model结构增加**:
```go
type Model struct {
    // ... 现有字段

    // 搜索模式相关 (v5.6)
    isSearchMode          bool
    searchIntradayWorker  *Worker
    searchIntradayData    *IntradayData
}
```

#### 国际化支持 (`i18n/zh.json`, `i18n/en.json`) (+18 lines each)

**新增调试翻译键**:
```json
{
  "debug.search.chartDataPoints": "[搜索] 图表数据点数量: %d",
  "debug.search.chartNoTimeFramework": "[搜索] 时间框架为空",
  "debug.search.chartPriceRange": "[搜索] 价格范围: min=%.3f, max=%.3f, margin=%.3f",
  "debug.search.chartSuccess": "[搜索] 图表创建成功"
}
```

---

## 📊 性能影响

| 指标 | 影响 | 说明 |
|------|------|------|
| **内存使用** | +1-2MB | 临时存储单个股票分时数据 |
| **磁盘I/O** | 无影响 | 不持久化搜索数据 |
| **网络请求** | +1次/5秒 | 仅在搜索视图激活时 |
| **启动时间** | 无影响 | 不影响应用启动 |

---

## 📝 使用说明

### 如何使用

1. 在主菜单选择 "搜索股票"
2. 输入股票代码或名称（如 `SH600000` 或 `浦发银行`）
3. 查看搜索结果 + 实时分时图表
4. 图表每5秒自动刷新（交易时间内）
5. 按 `ESC` 或 `Q` 退出，或按 `Enter`/`W` 添加到列表

### 交易时间外行为

- 非交易时间显示昨日收盘图表
- 使用智能日期选择逻辑（与主视图一致）
- 周末自动回溯到最近交易日

---

## 🔗 相关资源

- **Implementation Plan**: [SEARCH_INTRADAY_CHART_INTEGRATION.md](../plans/SEARCH_INTRADAY_CHART_INTEGRATION.md)
- **Commit**: `68c9a58 - Support search stock with view`
- **Files Changed**:
  - `doc/plans/SEARCH_INTRADAY_CHART_INTEGRATION.md` (新增, 1539 lines)
  - `main.go` (+186 lines)
  - `intraday_chart.go` (+366 lines)
  - `types.go` (+11 lines)
  - `i18n/zh.json`, `i18n/en.json` (+18 lines each)

---

## 🐛 已知限制

1. **搜索模式不保存数据**: 临时数据仅存储在内存中，退出后清除
2. **单股票限制**: 每次仅显示一个搜索结果的图表
3. **交易时间外**: 非交易时间显示昨日收盘图表（与主视图一致）

---

## 🚀 下一步计划

- v5.7: 标签分组系统优化（已在开发中）
- 考虑支持多股票对比图表
- 增加技术指标叠加功能（均线、成交量等）
