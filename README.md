# Stock Monitor - 股票监控系统

[![Version](https://img.shields.io/badge/version-v5.7-blue.svg)]()
[![Go](https://img.shields.io/badge/Go-1.25+-00ADD8.svg)]()
[![Platform](https://img.shields.io/badge/platform-macOS%20%7C%20Linux%20%7C%20Windows-lightgrey.svg)]()

> **AI Generated Repository**: 本项目完全由AI生成，包括代码架构、功能实现和项目文档。

**多语言文档**: [中文](README.md) | [English](README_EN.md)

专业的命令行股票监控工具，基于 Bubble Tea 框架构建现代化终端 UI，支持 A 股、美股、港股实时行情追踪与投资组合管理。

---

## 目录

- [功能特性](#-功能特性)
- [快速开始](#-快速开始)
- [界面展示](#-界面展示)
- [键盘快捷键](#-键盘快捷键)
- [系统架构](#-系统架构)
- [项目结构](#-项目结构)
- [配置说明](#-配置说明)
- [支持的市场与API](#-支持的市场与api)
- [故障排除](#-故障排除)
- [版本历史](#-版本历史)
- [使用技巧](#-使用技巧)

---

## 功能特性

### 核心功能

| 功能 | 说明 |
|------|------|
| **实时监控** | 5秒间隔自动刷新股价数据，掌握每个交易时刻 |
| **投资组合** | 完整的持仓管理，支持添加、修改、删除股票操作 |
| **自选股票** | 独立的股票关注列表，支持多标签分组和持仓高亮 |
| **分时图表** | 终端内查看分时走势图，Braille字符渲染平滑曲线 |
| **多标签管理** | 自选股票支持多个标签，灵活分组管理 |
| **全球市场** | 支持 A 股、美股、港股等主流市场股票代码格式 |
| **多语言** | 完整的中英文双语界面支持 |
| **数据持久** | 本地 JSON 存储，投资组合数据永不丢失 |

### 界面特性

- **现代化交互**: 基于 Bubble Tea 框架的响应式终端 UI
- **专业配色**: 红涨绿跌白平，符合专业股票软件标准
- **智能排序**: 支持按 11 个字段排序（持股）/ 7 个字段排序（自选）
- **分页显示**: 可配置每页显示行数，适应不同屏幕
- **Vim 风格**: 支持方向键、WASD、J/K 多种导航方式

### 数据功能

- **多维度数据**: 现价、开盘、最高、最低、昨收、涨跌幅
- **盈亏统计**: 今日盈亏、持仓盈亏、盈亏率实时计算
- **分时采集**: 后台自动采集分时数据，每分钟更新，永久保存
- **智能缓存**: 30秒 TTL 缓存，避免频繁 API 请求

---

## 快速开始

### 环境要求

- **Go 版本**: 1.25.0 或更高版本
- **网络连接**: 用于获取实时股票数据
- **系统支持**: Windows、macOS、Linux
- **终端**: 支持彩色显示（推荐）

### 安装运行

```bash
# 1. 克隆项目
git clone <repository-url>
cd stock-monitor

# 2. 安装依赖
go mod download

# 3. 编译程序
go build -o cmd/stock-monitor

# 4. 运行程序
./cmd/stock-monitor
```

### 首次使用

- **无持仓数据**: 程序显示主菜单，引导用户添加股票
- **有持仓数据**: 程序自动进入实时监控模式

---

## 界面展示

### 持股列表 (Portfolio)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  实时监控 - 持股列表                                        每5秒自动刷新      │
├──────────┬──────────┬────────┬────────┬────────┬─────────┬──────────┬─────────┤
│   代码   │   名称   │  现价  │ 成本价 │ 持股数 │今日涨幅 │ 持仓盈亏 │ 盈亏率  │
├──────────┼──────────┼────────┼────────┼────────┼─────────┼──────────┼─────────┤
│ SH601138 │ 工业富联 │  61.63 │  51.98 │   500  │  -2.91% │  +4,825  │ +18.6%  │
│ SZ000001 │ 平安银行 │  12.45 │  11.20 │  1000  │  +1.22% │  +1,250  │ +11.2%  │
│ AAPL     │ 苹果公司 │ 189.95 │ 175.00 │   100  │  +0.85% │  +1,495  │  +8.5%  │
└──────────┴──────────┴────────┴────────┴────────┴─────────┴──────────┴─────────┘
                              总盈亏: +7,570  |  总市值: ¥62,705
```

### 自选列表 (Watchlist)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  自选股票                                    标签筛选: 全部  |  每5秒自动刷新   │
├──────────┬──────────┬──────────┬────────┬─────────┬─────────┬────────┬────────┤
│   标签   │   代码   │   名称   │  现价  │今日涨幅 │ 换手率  │ 成交量 │  最高  │
├──────────┼──────────┼──────────┼────────┼─────────┼─────────┼────────┼────────┤
│ 白酒     │ SH600519 │ 贵州茅台 │1668.00 │  +1.25% │  0.35%  │  3.2万 │1680.00 │
│ 科技     │ SZ000725 │ 京东方A  │   4.52 │  -0.88% │  1.82%  │ 15.6亿 │   4.58 │
│ 新能源   │ SZ002594 │ 比亚迪   │ 238.50 │  +2.15% │  0.95%  │  2.8亿 │ 241.00 │
└──────────┴──────────┴──────────┴────────┴─────────┴─────────┴────────┴────────┘
```

### 分时图表 (Intraday Chart)

按 `V` 键查看选中股票的分时走势图：

```
   浦发银行 (SH600000) - 2025-12-02

   8.60 ┤
        │         ⠠⠊⠑⠢⡀
   8.55 ┤     ⠔⠁      ⠑⢄⠠⠔⠊⠢⡀
        │  ⡠⠊            ⠑⢄   ⠑⠢⡀
   8.50 ┼⠔⠁                  ⠑⠤⣀⠔⠊⠑⠢⣀
        │
   8.45 ┤
        └────────────────────────────────────────────
         09:30     10:30     11:30   13:00   14:00   15:00

   昨收: 8.48  |  开盘: 8.52  |  最高: 8.58  |  最低: 8.45
```

---

## 键盘快捷键

### 通用快捷键

| 按键 | 功能 |
|------|------|
| `↑` `↓` 或 `W` `S` 或 `J` `K` | 上下导航 |
| `Enter` 或 `Space` | 确认选择 |
| `ESC` 或 `Q` | 返回上级 |
| `Ctrl+C` | 强制退出 |

### 输入框编辑

| 按键 | 功能 |
|------|------|
| `←` `→` | 移动光标 |
| `Backspace` | 删除前一字符 |
| `Delete` | 删除后一字符 |

### 持股列表专用

| 按键 | 功能 |
|------|------|
| `A` | 添加新股票（跳转搜索） |
| `E` | 修改选中股票 |
| `D` | 删除选中股票 |
| `S` | 进入排序设置 |
| `V` | 查看分时图表 |

### 自选列表专用

| 按键 | 功能 |
|------|------|
| `A` | 添加股票到自选 |
| `D` | 删除自选股票 |
| `T` | 标签管理（添加/删除/编辑） |
| `G` | 按标签分组查看 |
| `C` | 清除标签筛选 |
| `S` | 进入排序设置 |
| `V` | 查看分时图表 |

### 排序菜单

| 按键 | 功能 |
|------|------|
| `↑` `↓` | 选择排序字段 |
| `Enter` | 应用排序/切换升降序 |
| `C` | 清除排序 |

---

## 系统架构

### 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    UI Layer                                 │
│          Bubble Tea Framework + Go-Pretty Tables            │
│              main.go | ui_utils.go | format.go              │
├─────────────────────────────────────────────────────────────┤
│                 Business Logic Layer                        │
│           State Machine + Feature Modules                   │
│         watchlist.go | intraday_chart.go | sort.go          │
├─────────────────────────────────────────────────────────────┤
│                    Data Layer                               │
│              Cache + Persistence + Types                    │
│          cache.go | persistence.go | types.go               │
├─────────────────────────────────────────────────────────────┤
│               External Integration Layer                    │
│               Multi-API with Fallback                       │
│                api.go | intraday.go                         │
├─────────────────────────────────────────────────────────────┤
│                Cross-Cutting Concerns                       │
│          i18n.go | debug.go | color.go | consts.go          │
└─────────────────────────────────────────────────────────────┘
```

### 核心模块

| 模块 | 代码行数 | 职责 | 说明 |
|------|:--------:|------|------|
| `main.go` | 3,156 | 状态机与事件处理 | 核心应用逻辑，19个状态，Bubble Tea 事件循环 |
| `api.go` | 1,226 | API 集成 | 多数据源获取与自动容错机制 |
| `intraday_chart.go` | 754 | 分时图表 | Braille 字符渲染，智能日期选择，自适应Y轴 |
| `intraday.go` | 616 | 分时采集 | 后台工作池（最多10并发），每分钟自动更新 |
| `watchlist.go` | 508 | 自选管理 | 多标签操作、筛选、分组、搜索 |
| `sort.go` | 238 | 排序引擎 | 11个持股字段 + 7个自选字段排序 |
| `types.go` | 215 | 数据结构 | Stock, StockData, Config 等核心类型 |
| `persistence.go` | 171 | 数据持久化 | JSON/YAML 读写，备份恢复 |
| `cache.go` | 129 | 价格缓存 | 30秒 TTL，RWMutex 并发保护 |
| `ui_utils.go` | 194 | UI 工具 | 表格格式化，中文宽度处理，分页 |

### 技术栈

| 组件 | 版本 | 用途 |
|------|------|------|
| **Bubble Tea** | v1.3.6 | 终端 UI 框架，响应式交互 |
| **Go-Pretty** | v6.6.8 | 表格布局，中文对齐 |
| **ntcharts** | v0.3.1 | Braille 字符图表渲染 |
| **golang.org/x/text** | v0.28.0 | GBK/UTF-8 编码转换 |
| **YAML v3** | v3.0.1 | 配置文件处理 |

---

## 项目结构

```
stock-monitor/
├── main.go                 # 核心应用：状态机、事件处理（3,156行）
├── api.go                  # API集成：多源数据获取与容错（1,226行）
├── intraday_chart.go       # 分时图表：Braille渲染（754行）
├── intraday.go             # 分时采集：后台工作池（616行）
├── watchlist.go            # 自选管理：标签、分组（508行）
├── sort.go                 # 排序引擎（238行）
├── types.go                # 数据结构定义（215行）
├── ui_utils.go             # UI工具函数（194行）
├── persistence.go          # 数据持久化（171行）
├── format.go               # 格式化工具（156行）
├── debug.go                # 调试日志（153行）
├── cache.go                # 价格缓存（129行）
├── scroll.go               # 滚动处理（77行）
├── consts.go               # 常量定义（71行）
├── i18n.go                 # 国际化（57行）
├── color.go                # 颜色工具（55行）
├── go.mod / go.sum         # Go模块依赖
│
├── cmd/
│   ├── stock-monitor       # 编译后的可执行文件
│   └── conf/
│       ├── config.yml      # 用户配置文件（自动生成）
│       └── config_demo.yaml # 配置模板（含双语注释）
│
├── data/
│   ├── portfolio.json      # 投资组合数据
│   ├── watchlist.json      # 自选股票数据
│   └── intraday/           # 分时数据目录
│       ├── SH600000/       # 按股票代码组织
│       │   ├── 20251202.json
│       │   └── 20251203.json
│       └── SZ000001/
│           └── 20251202.json
│
├── i18n/
│   ├── zh.json             # 中文语言包（~250条）
│   └── en.json             # 英文语言包（~250条）
│
├── doc/
│   ├── version/            # 版本历史文档
│   └── issues/             # 功能文档
│
├── README.md               # 中文文档
└── README_EN.md            # 英文文档
```

---

## 配置说明

### 配置文件位置

`cmd/conf/config.yml` - 首次运行时自动创建

### 配置选项

| 配置项 | 默认值 | 说明 | 可选值 |
|--------|--------|------|--------|
| `system.language` | `zh` | 系统语言 | `zh`, `en` |
| `system.auto_start` | `true` | 有数据时自动进入监控 | `true`, `false` |
| `system.startup_module` | `portfolio` | 启动模块 | `portfolio`, `watchlist` |
| `system.debug_mode` | `false` | 调试模式 | `true`, `false` |
| `display.color_scheme` | `professional` | 颜色方案 | `professional`, `simple` |
| `display.decimal_places` | `3` | 价格小数位 | `1-4` |
| `display.table_style` | `light` | 表格样式 | `light`, `bold`, `simple` |
| `display.max_lines` | `10` | 每页行数 | 任意正整数 |
| `display.portfolio_highlight` | `yellow` | 持仓高亮色 | `black`, `red`, `green`, `yellow`, `blue`, `magenta`, `cyan`, `white` |
| `update.refresh_interval` | `5` | 刷新间隔(秒) | 任意正整数 |
| `update.auto_update` | `true` | 自动刷新 | `true`, `false` |

### 配置文件示例

```yaml
system:
    language: zh
    auto_start: true
    startup_module: portfolio
    debug_mode: false

display:
    color_scheme: professional
    decimal_places: 3
    table_style: light
    max_lines: 10
    portfolio_highlight: yellow

update:
    refresh_interval: 5
    auto_update: true
```

### v5.2 新增：可定制表格列

v5.2 引入了灵活的表格列配置系统，允许用户自定义显示的列和顺序。

#### 持股列表可配置列（14列）

**必需列**（无法移除）:
- `cursor` - 光标选中指示器
- `code` - 股票代码
- `name` - 股票名称
- `price` - 现价

**可选列**（可根据需要启用/禁用）:
- `prev_close` - 昨收价
- `open` - 开盘价
- `high` - 最高价
- `low` - 最低价
- `cost` - 成本价
- `quantity` - 持股数
- `today_change` - 今日涨幅
- `position_profit` - 持仓盈亏
- `profit_rate` - 盈亏率
- `market_value` - 市值

#### 自选列表可配置列（12列）

**必需列**（无法移除）:
- `cursor` - 光标选中指示器
- `tag` - 标签
- `code` - 股票代码
- `name` - 股票名称
- `price` - 现价

**可选列**（可根据需要启用/禁用）:
- `prev_close` - 昨收价
- `open` - 开盘价
- `high` - 最高价
- `low` - 最低价
- `today_change` - 今日涨幅
- `turnover` - 换手率
- `volume` - 成交量

#### 配置示例

**简洁模式**（只显示核心信息）:
```yaml
display:
  portfolio_columns:
    - cursor
    - code
    - name
    - price
    - position_profit
    - profit_rate

  watchlist_columns:
    - cursor
    - tag
    - code
    - name
    - price
    - today_change
```

**自定义优先级模式**（盈亏信息优先）:
```yaml
display:
  portfolio_columns:
    - cursor
    - code
    - name
    - price
    - position_profit     # 优先显示盈亏
    - profit_rate         # 优先显示盈亏率
    - cost
    - quantity
    - today_change
    - market_value
```

**详细模式**（显示所有列，默认配置）:
```yaml
display:
  portfolio_columns:
    - cursor
    - code
    - name
    - prev_close
    - open
    - high
    - low
    - price
    - cost
    - quantity
    - today_change
    - position_profit
    - profit_rate
    - market_value

  watchlist_columns:
    - cursor
    - tag
    - code
    - name
    - price
    - prev_close
    - open
    - high
    - low
    - today_change
    - turnover
    - volume
```

**使用提示**:
- 列按配置文件中的顺序从左到右显示
- 注释掉某一行即可隐藏该列（必需列除外）
- 必需列缺失时会自动补全，确保界面正常工作
- 修改配置后重启应用生效

#### 分时数据采集配置 (v5.3+)

v5.3 新增了智能的分时数据采集系统，支持通过配置文件进行定制。

**默认配置（推荐）**:
```yaml
intraday_collection:
  enable_auto_stop: true            # 启用智能自动停止
  completeness_threshold: 90.0      # 完整性阈值（百分比）
  max_consecutive_errors: 5         # 最大连续错误次数
  min_datapoints: 20                # 最小数据点数量
```

**配置项说明**:

| 配置项 | 含义 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `enable_auto_stop` | 启用自动停止 | true | true/false | 关闭时Worker持续运行 |
| `completeness_threshold` | 完整性阈值 | 90.0 | 50.0-100.0 | 达到此比例时认为数据完整 |
| `max_consecutive_errors` | 最大错误次数 | 5 | 1-20 | 连续错误超过此数时停止 |
| `min_datapoints` | 最小数据点 | 20 | 10-100 | 数据点数小于此值时不判定完整 |

**场景配置**:

**低网络带宽**:
```yaml
intraday_collection:
  enable_auto_stop: true
  completeness_threshold: 85.0      # 降低阈值，快速停止
  max_consecutive_errors: 3         # 较低容错
  min_datapoints: 15
```

**数据质量优先**:
```yaml
intraday_collection:
  enable_auto_stop: true
  completeness_threshold: 95.0      # 提高阈值，确保完整
  max_consecutive_errors: 10        # 较高容错
  min_datapoints: 50
```

---

## 支持的市场与API

### 股票代码格式

| 市场 | 输入格式 | 示例 | API格式 |
|------|----------|------|---------|
| **上交所 A股** | `SH + 6位数字` 或 `6位数字` | `SH601138`, `601138` | `601138.SS` |
| **深交所 A股** | `SZ + 6位数字` 或 `6位数字` | `SZ000001`, `000001` | `000001.SZ` |
| **美股** | 股票代码 | `AAPL`, `TSLA`, `MSFT` | 直接使用 |
| **港股** | `HK + 5位数字` 或 标准格式 | `HK00700`, `0700.HK` | `0700.HK` |

### 数据源与API

| 优先级 | API | 市场 | 用途 |
|:------:|-----|------|------|
| 1 | **腾讯 API** | A股 | 实时行情（主） |
| 2 | **新浪 API** | A股 | 实时行情（备）、分时数据（主） |
| 3 | **东方财富** | A股/港股 | 分时数据（备）、港股换手率 |
| 4 | **Finnhub** | 美股/港股 | 实时行情 |
| 5 | **TwelveData** | 美股 | 股票搜索（备） |

### 容错机制

```
A股实时数据:  腾讯 API → 新浪 API → 显示 "-"
分时数据:     新浪财经 → 东方财富 → 跳过
股票搜索:     腾讯搜索 → 新浪搜索 → TwelveData → 未找到提示
```

- **自动重试**: API 失败后自动尝试下一个数据源
- **智能选择**: 根据股票类型选择最优数据源
- **优雅失败**: 无法获取数据时显示 "-"，不影响程序运行

---

## 故障排除

### 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 股票数据显示 "-" | 网络问题 / API 异常 / 代码无效 | 检查网络，确认代码正确 |
| 颜色显示异常 | 终端不支持 ANSI | 使用支持颜色的终端 |
| 中文显示乱码 | 编码/字体问题 | 检查终端字体设置 |
| 响应延迟 | 网络慢 / API 响应慢 | 检查网络环境 |

### 调试模式

1. 在主菜单开启 "调试模式"
2. 进入监控页面后按 `D` 键查看调试日志
3. 日志显示 API 调用详情和错误信息

### 获取帮助

如遇问题，请提供以下信息：
- 操作系统版本
- Go 语言版本
- 错误日志截图
- 相关股票代码

---

## 版本历史

### 当前版本 - v5.7 (2025年12月)

**🏷️ 自选标签分组系统**

- **标签分组显示**: 市场分组与用户标签清晰分类，分组UI设计
- **位置记忆功能**: 记住上次选择的标签，快速回到上次位置
- **边界停留**: 列表首尾停留，避免循环滚动，更直观的导航体验
- **视觉优化**: 分组间清晰分隔符，提升可读性
- **完整双语支持**: 完善的中英文支持
- **向下兼容**: 完全兼容v5.6及更早版本

### 版本历史

| 版本 | 发布时间 | 主要更新 | 文档 |
|------|----------|----------|------|
| **v5.7** | 2025年12月 | 🏷️ 自选标签分组系统、位置记忆、边界停留 | [查看详情](doc/changelogs/v5.7.md) |
| v5.6 | 2025年12月 | 🔍 搜索视图增强、实时分时图、自动刷新 | [查看详情](doc/changelogs/v5.6.md) |
| v5.5 | 2025年12月 | 🏷️ 自选股票市场标签体系、数据自动迁移 | [查看详情](doc/changelogs/v5.5.md) |
| v5.4 | 2025年12月 | 🔧 港股换手率修复、东方财富API集成 | [查看详情](doc/changelogs/v5.4.md) |
| v5.3 | 2025年12月 | 🛡️ 关键修复、智能Worker系统、多市场时区增强 | [查看详情](doc/changelogs/v5.3.md) |
| v5.2 | 2025年12月 | 📊 可定制表格列、灵活配置、用户体验升级 | [查看详情](doc/changelogs/v5.2.md) |
| v5.1 | 2025年12月 | 🌍 多市场支持、美股港股盘中数据、Yahoo API、单元测试 | [查看详情](doc/changelogs/v5.1.md) |
| v5.0 | 2025年12月 | 🏗️ 架构现代化，完整模块化设计 | [查看详情](doc/changelogs/v5.0.md) |
| v4.9 | 2025年11月 | 分时图表增强，智能日期选择 | [查看详情](doc/changelogs/v4.9.md) |
| v4.8 | 2025年11月 | 多标签系统，用户体验优化 | [查看详情](doc/changelogs/v4.8.md) |
| v4.7 | 2025年10月 | 架构优化，国际化增强 | [查看详情](doc/changelogs/v4.7.md) |
| v4.6 | 2025年10月 | 分时数据采集，异步优化 | [查看详情](doc/changelogs/v4.6.md) |
| v4.5 | 2025年09月 | 高级排序系统 | [查看详情](doc/changelogs/v4.5.md) |

查看完整版本历史: [doc/version/](doc/changelogs/)

---

## 使用技巧

### 最佳使用时间

| 时间段 | 市场状态 | 数据质量 |
|--------|----------|----------|
| 09:30-15:00 | A股交易时间 | 实时数据 |
| 21:30-04:00 | 美股交易时间 | 实时数据 |
| 非交易时间 | 市场关闭 | 昨日收盘价 |

### 高效操作

- **批量管理**: 使用自选列表关注多只股票，再选择性添加到持股
- **多标签分组**: 为自选股票添加多个标签（如"科技"、"医药"）灵活分类
- **排序分析**: 利用排序功能按盈亏率、涨跌幅等维度分析表现
- **持仓识别**: 注意自选列表中高亮的持仓股票
- **分时图表**: 按 `V` 键快速查看股票分时走势

### 配置优化

- 根据屏幕大小调整 `display.max_lines`
- 调整 `update.refresh_interval` 平衡实时性和网络负载
- 使用 `display.portfolio_highlight` 自定义持仓高亮颜色

---

> **温馨提示**: 请在交易时间使用获得最准确数据，非交易时间显示最后交易价格。本工具仅供投资参考，投资有风险，入市需谨慎。
